# Redis

## 简介

Redis 是一种基于内存的数据库，对数据的读写操作都是在内存中完成，因此读写速度非常快，常用于缓存，消息队列、分布式锁等场景。

Redis 提供了多种数据类型来支持不同的业务场景，比如 String(字符串)、Hash(哈希)、 List (列表)、Set(集合)、Zset(有序集合)、Bitmaps（位图）、HyperLogLog（基数统计）、GEO（地理信息）、Stream（流），并且对数据类型的操作都是原子性的，因为执行命令由单线程负责的，不存在并发竞争的问题。

除此之外，Redis 还支持事务 、持久化、Lua 脚本、多种集群方案（主从复制模式、哨兵模式、切片机群模式）、发布/订阅模式，内存淘汰机制、过期删除机制等等。

## Redis线程模型

Redis 单线程模型是指 `接收客户端请求 -> 解析请求 -> 进行数据读写 -> 发送给客户端` 这一个过程是是由一个线程「主线程」完成的. 这就是Redis是单线程的原因.

但是Redis程序并不是单线程, 是会启动后台进程「BIO」的.

1. 在Redis 2.6版本, Redis会启动两个后台线程, 用来关闭文件和AOF刷盘
2. 在Redis 4.0版本以后, 新增了一个后台线程,用来异步释放Redis内存,也就是lazyfree线程.

### 后台线程工作机制

简单来说, 后台线程和主线程就是**生产者-消费者模型**

![work](images/redis_bio_work.excalidraw.png)

关闭文件、AOF 刷盘、释放内存这三个任务都有各自的任务队列：

- BIO_CLOSE_FILE，关闭文件任务队列：当队列有任务后，后台线程会调用 close(fd) ，将文件关闭；
- BIO_AOF_FSYNC，AOF刷盘任务队列：当 AOF 日志配置成 everysec 选项后，主线程会把 AOF 写日志操作封装成一个任务，也放到队列中。当发现队列有任务后，后台线程会调用 fsync(fd)，将 AOF 文件刷盘，
- BIO_LAZY_FREE，lazy free 任务队列：当队列有任务后，后台线程会 free(obj) 释放对象 / free(dict) 删除数据库所有对象 / free(skiplist) 释放跳表对象；
